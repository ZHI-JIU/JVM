# 堆

## 堆的核心概述
- 一个进程对应一个jvm实例，只有一个堆内存。堆是java内存管理的核心区域。
- java堆在jvm启动时即被创建，其大小有确定了（可调节的）。是jvm中最大的一块内存空间。
    - Xms 初始堆空间大小
    - Xmx 最大堆空间大小
- 堆可以物理上不连续，逻辑上是连续的。物理内存和虚拟内存有映射表，虚拟内存中连续的部分在实际的物理内存上是不连续的。
- 堆是线程共享的，但是可以在堆上划分出线程私有的**缓冲区**（Thread Local Allocation Buffer，TLAB），为了提升并发性能。
- jvm规范：所有的对象实例、数组都应当在运行时分配在堆上。实际使用时可以具体分体具体分析。也有可能存储在栈上。
- 数组和对象可能永远不会存储在栈上，因为栈帧保存引用，引用指向对象、数组在堆中的位置。
- 方法结束后，堆中的对象不会马上被移除（栈帧会出栈，堆中的对象只是没有局部变量表中的引用指向它），在GC时才会被移除。
- 堆是GC的重点区域。

### 堆的内存细分
现代的GC大部分都是基于分代收集理论设计的。
- jdk7及以前，逻辑上分为三部分：
    - 新生区
        - Eden区
        - Survivor区（又分成s0和s1区）
    - 养老区
    - 永久区（方法区的落地方案）
- jdk8及以后，逻辑上分为三部分：
    - 新生区
        - Eden区
        - Survivor区（又分成s0和s1区）
    - 养老区
    - 元空间（方法区的落地方案）

## 设置堆内存大小与OOM
- Xms 初始堆空间（新生代+老年代）大小，等价于-XX:InitialHeapSize
    - -X：jvm的运行参数
    - ms：member start的缩写
- Xmx 最大堆空间大小，等价于-XX:MaxHeapSize
- 默认值：
    - 初始内存： 物理内存 / 64
    - 最大内存： 物理存储 / 4
- 获取jvm中的堆内存大小
    ``Runtime.getRuntime().totalMemory()``  
- 获取jvm中的最大堆内存大小 
    ``Runtime.getRuntime().maxMemory()``
- 这两个值最好设置成一样，减少扩缩容对服务器的压力。    
- 查看堆空间的大小：
    - 方式一： jps查看进程号 + jstat -gc 进程号 查看各个区的大小和已使用空间
    - 方式二： -XX：+PrintGCDetails，程序执行完后会输出。  
    ![image](GCdetail)
    
## 年轻代与老年代

## 对象分配过程

## Minor GC，Major GC，Full GC

## 堆空间分代思想

## 内存分配策略

## 为对象分配内存：TLAB

## 堆空间的参数设置
- XX 
- jstat -gc 进程号 查看gc情况
- jps 查看当前进程
- -XX：+PrintGCDetails

## 堆是分配对象的唯一选择么